<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='homepage/style.css') }}"
    />
    <title>ChaoNungSue - Home</title>
  </head>

  <body>
    <div class="navbar">
      <h2>ChaoNungSue</h2>

      <div class="search-container">
        <input
          type="text"
          id="searchInput"
          placeholder="Enter book name"
          onkeyup="searchBooks()"
        />
        <i class="bx bx-search"></i>
      </div>

      <ul>
        <li><a href="#">Home</a></li>
        <li><a href="#">Skills</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
      <button class="hire-btn" onclick="login()">Login</button>
    </div>

    <div id="hero-section">
      <div class="main">
        <h4>Welcome to ChaoNungSue</h4>
        <p class="title">Your Virtual Library</p>
        <p class="subtitle">
          Borrow books of your interests, or just take a look around!
        </p>
      </div>
    </div>

    <div class="content-container">
      <div class="section-header">
        <h2 id="displayTitle">Recommended Books</h2>
        <span id="resultCount" style="color: #666; font-size: 14px"></span>
      </div>

      <div class="filter-container" id="filterButtons"></div>

      <div class="book-grid" id="bookDisplay"></div>
    </div>

    <script>
      // โหลดข้อมูลจากไฟล์ CSV
      let allBooks = [];

      async function fetchBooks() {
        try {
          const response = await fetch("books.csv");
          const data = await response.text();
          const rows = data.split(/\r?\n/).filter((row) => row.trim() !== "");
          const rowsWithoutHeader = rows.slice(1);

          allBooks = rowsWithoutHeader
            .map((row) => {
              const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
              if (cols && cols.length >= 5) {
                return {
                  title: cols[0].trim().replace(/"/g, ""),
                  category: cols[1].trim().replace(/"/g, ""),
                  tags: cols[2].replace(/"/g, "").trim(),
                  rating: cols[3].trim().replace(/"/g, ""),
                  img:
                    cols[4]?.trim().replace(/"/g, "") ||
                    "https://via.placeholder.com/200x300?text=No+Cover",
                };
              }
              return null;
            })
            .filter((b) => b !== null);

          createFilterButtons(); // Generate the genre buttons
          displayBooks(allBooks); // Show all books initially
        } catch (error) {
          console.error("Error loading CSV:", error);
        }
      }

      // FIX: Generate dynamic buttons based on categories in CSV
      function createFilterButtons() {
        const filterContainer = document.getElementById("filterButtons");

        // Get unique categories and add 'All'
        const categories = [
          "All",
          ...new Set(allBooks.map((book) => book.category)),
        ];

        filterContainer.innerHTML = categories
          .map(
            (cat) => `
    <button class="filter-btn" onclick="filterByCategory('${cat}')">${cat}</button>
  `,
          )
          .join("");
      }

      // FIX: Filter function
      function filterByCategory(category) {
        if (category === "All") {
          displayBooks(allBooks);
        } else {
          const filtered = allBooks.filter(
            (book) => book.category === category,
          );
          displayBooks(filtered);
        }

        // Update title to show what we are looking at
        document.getElementById("displayTitle").innerText =
          category === "All" ? "Recommended Books" : `Genre: ${category}`;
      }

      function displayBooks(books) {
        const container = document.getElementById("bookDisplay");
        const htmlContent = books
          .map((book) => {
            const tagList = book.tags.split(",").map((t) => t.trim());
            return `
      <div class="book-card">
        <div class="thumbnail">
          <img src="${book.img}" alt="${book.title}" onerror="this.src='https://via.placeholder.com/200x300?text=No+Cover'">
        </div>
        <div class="book-info">
          <h3 class="book-title">${book.title}</h3>
          <p class="book-category"><strong>Category:</strong> ${book.category}</p>
          <div class="book-tags">
            <ul>${tagList.map((tag) => `<li>${tag}</li>`).join("")}</ul>
          </div>
          <p class="book-stats"><strong>Rating:</strong> ${book.rating}</p>
        </div>
      </div>
    `;
          })
          .join("");
        container.innerHTML = htmlContent;
      }

      window.onload = fetchBooks;

      function searchBooks() {
        const term = document.getElementById("searchInput").value.toLowerCase();
        const filtered = allBooks.filter(
          (book) =>
            book.title.toLowerCase().includes(term) ||
            book.category.toLowerCase().includes(term) ||
            book.tags.toLowerCase().includes(term),
        );

        displayBooks(filtered);

        const displayTitle = document.getElementById("displayTitle");
        if (displayTitle) {
          displayTitle.innerText = term
            ? `Search Results`
            : "Recommended Books";
        }
      }

      fetchBooks();

      function login() {
        window.location.href = "../loginpage/login.html";
      }
      window.onload = fetchBooks;
    </script>
  </body>
</html>
