<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='homepage/style.css') }}"
    />
    <title>ChaoNungSue - Home</title>
  </head>

  <body>
    <div class="navbar">
      <h2>ChaoNungSue</h2>

      <div class="search-container">
        <input
          type="text"
          id="searchInput"
          placeholder="Enter book name"
          onkeyup="searchBooks()"
        />
      </div>

      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="#">Skills</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
      <button class="hire-btn" onclick="goToLogin()">Login</button>
    </div>

    <div id="hero-section">
      <div class="main">
        <h4>Welcome to ChaoNungSue</h4>
        <p class="title">Your Virtual Library</p>
        <p class="subtitle">
          Borrow books of your interests, or just take a look around!
        </p>
      </div>
    </div>

    <div class="content-container">
      <div class="section-header">
        <h2 id="displayTitle">Recommended Books</h2>
        <span id="resultCount" style="color: #666; font-size: 14px"></span>
      </div>

      <div class="filter-container" id="filterButtons"></div>

      <div class="book-grid" id="bookDisplay"></div>
    </div>

    <script>
      let allBooks = [];

      // FIX 1: Fetch from the STATIC folder
      async function fetchBooks() {
        try {
          const response = await fetch("/static/books.csv");
          if (!response.ok)
            throw new Error("Could not find books.csv in static folder");

          const data = await response.text();
          const rows = data.split(/\r?\n/).filter((row) => row.trim() !== "");
          const rowsWithoutHeader = rows.slice(1);

          allBooks = rowsWithoutHeader
            .map((row) => {
              // This regex handles commas inside quotes in CSVs
              const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
              if (cols && cols.length >= 5) {
                return {
                  title: cols[0].trim().replace(/"/g, ""),
                  category: cols[1].trim().replace(/"/g, ""),
                  tags: cols[2].replace(/"/g, "").trim(),
                  rating: cols[3].trim().replace(/"/g, ""),
                  img: cols[4]?.trim().replace(/"/g, ""),
                };
              }
              return null;
            })
            .filter((b) => b !== null);

          createFilterButtons();
          displayBooks(allBooks);
        } catch (error) {
          console.error("Error loading CSV:", error);
          document.getElementById("bookDisplay").innerHTML =
            "<p>Error loading book data. Please check console.</p>";
        }
      }

      function createFilterButtons() {
        const filterContainer = document.getElementById("filterButtons");
        const categories = [
          "All",
          ...new Set(allBooks.map((book) => book.category)),
        ];

        filterContainer.innerHTML = categories
          .map(
            (cat) =>
              `<button class="filter-btn" onclick="filterByCategory('${cat}')">${cat}</button>`,
          )
          .join("");
      }

      function filterByCategory(category) {
        const filtered =
          category === "All"
            ? allBooks
            : allBooks.filter((b) => b.category === category);
        displayBooks(filtered);
        document.getElementById("displayTitle").innerText =
          category === "All" ? "Recommended Books" : `Genre: ${category}`;
      }

      function displayBooks(books) {
        const container = document.getElementById("bookDisplay");
        container.innerHTML = books
          .map((book) => {
            const tagList = book.tags.split(",").map((t) => t.trim());

            // FIX 2: Handle image paths correctly
            // If your CSV has image names like "book1.jpg", use /static/images/
            // If your CSV has full URLs, just use book.img
            const imageSrc = book.img.startsWith("http")
              ? book.img
              : `/static/images/${book.img}`;

            return `
              <div class="book-card">
                <div class="thumbnail">
                  <img src="${imageSrc}" alt="${book.title}" onerror="this.src='https://via.placeholder.com/200x300?text=No+Cover'">
                </div>
                <div class="book-info">
                  <h3 class="book-title">${book.title}</h3>
                  <p class="book-category"><strong>Category:</strong> ${book.category}</p>
                  <div class="book-tags">
                    <ul>${tagList.map((tag) => `<li>${tag}</li>`).join("")}</ul>
                  </div>
                  <p class="book-stats"><strong>Rating:</strong> ${book.rating}</p>
                </div>
              </div>`;
          })
          .join("");
      }

      function searchBooks() {
        const term = document.getElementById("searchInput").value.toLowerCase();
        const filtered = allBooks.filter(
          (book) =>
            book.title.toLowerCase().includes(term) ||
            book.category.toLowerCase().includes(term),
        );
        displayBooks(filtered);
        document.getElementById("displayTitle").innerText = term
          ? "Search Results"
          : "Recommended Books";
      }

      // FIX 3: Correct Login Redirect
      function goToLogin() {
        window.location.href = "/";
      }

      // Start the process
      window.onload = fetchBooks;
    </script>
  </body>
</html>
