<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <title>ChaoNungSue - Home</title>
  </head>

  <body>
    <div class="navbar">
      <h2>ChaoNungSue</h2>

      <div class="search-container">
        <input
          type="text"
          id="searchInput"
          placeholder="ค้นหาหนังสือหรือชื่อผู้เขียน..."
          onkeyup="searchBooks()"
        />
        <i class="bx bx-search"></i>
      </div>

      <ul>
        <li><a href="#">Home</a></li>
        <li><a href="#">Skills</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
      <button class="hire-btn" onclick="login()">Login</button>
    </div>

    <div id="hero-section">
      <div class="main">
        <h4>Welcome to ChaoNungSue</h4>
        <p class="title">Your Virtual Library</p>
        <p class="subtitle">
          Borrow books of your interests, or just take a look around!
        </p>
      </div>
    </div>

    <div class="content-container">
      <div class="section-header">
        <h2 id="displayTitle">Recommended Books</h2>
        <span id="resultCount" style="color: #666; font-size: 14px"></span>
      </div>

      <div class="book-grid" id="bookDisplay"></div>
    </div>

    <script>
      let allBooks = [];

      // โหลดข้อมูลจากไฟล์ CSV
      async function fetchBooks() {
        try {
          const response = await fetch("books.csv");
          const data = await response.text();

          const rows = data.split(/\r?\n/).filter((row) => row.trim() !== "");
          const rowsWithoutHeader = rows.slice(1);

          const allBooks = rowsWithoutHeader
            .map((row) => {
              // Smart split to handle commas inside quotes
              const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);

              if (cols && cols.length >= 5) {
                // Clean the column data
                const title = cols[0].trim().replace(/"/g, "");
                const category = cols[1].trim().replace(/"/g, "");
                const tags = cols[2].replace(/"/g, "").trim();
                const rating = cols[3].trim().replace(/"/g, "");

                // Prepare the image URL
                const rawImg = cols[4]?.trim().replace(/"/g, "");

                return {
                  title: title,
                  category: category,
                  tags: tags,
                  rating: rating,
                  // If rawImg is null, undefined, or an empty string, use the placeholder
                  img:
                    rawImg ||
                    "https://via.placeholder.com/200x300?text=No+Cover",
                };
              }
              return null;
            })
            .filter((b) => b !== null);

          displayBooks(allBooks);
        } catch (error) {
          console.error("Error loading CSV:", error);
        }
      }

      function displayBooks(books) {
        const container = document.getElementById("bookDisplay");

        const htmlContent = books
          .map((book) => {
            const tagList = book.tags.split(",").map((t) => t.trim());

            return `
      <div class="book-card">
        <div class="thumbnail">
          <img src="${book.img}" 
               alt="${book.title}" 
               onerror="this.src='https://via.placeholder.com/200x300?text=Error+Loading'">
        </div>
        <div class="book-info">
          <h3 class="book-title">${book.title}</h3>
          <p class="book-category"><strong>Category:</strong> ${book.category}</p>
          <div class="book-tags">
            <strong>Tags:</strong>
            <ul>
              ${tagList.map((tag) => `<li>${tag}</li>`).join("")}
            </ul>
          </div>
          <p class="book-stats"><strong>Rating:</strong> ${book.rating}</p>
        </div>
      </div>
    `;
          })
          .join("");

        container.innerHTML = htmlContent;
      }

      fetchBooks();

      // ฟังก์ชันค้นหา
      function searchBooks() {
        const term = document.getElementById("searchInput").value.toLowerCase();
        const filtered = allBooks.filter(
          (book) =>
            book.title.toLowerCase().includes(term) ||
            book.author.toLowerCase().includes(term),
        );

        displayBooks(filtered);
        document.getElementById("displayTitle").innerText = term
          ? `Search Results`
          : "Recommended Books";
        document.getElementById("resultCount").innerText = term
          ? `(${filtered.length} found)`
          : "";
      }

      function login() {
        window.location.href = "../loginpage/login.html";
      }
      window.onload = fetchBooks;
    </script>
  </body>
</html>
